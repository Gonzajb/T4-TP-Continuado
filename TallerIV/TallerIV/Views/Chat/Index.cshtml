@model TallerIV.Dominio.Encuentro

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutProui.cshtml";
}

<div class="content-header">
    <div class="header-section">
        <h1>
            <i class="fa fa-chat"></i>Chat
        </h1>
    </div>
</div>
<div class="row">
    <div class="block">
        <!-- Block Title -->
        <div class="block-title">
            <h2><strong>Conversación</strong> Ezequiel</h2>
        </div>
        <!-- END Block Title -->
        <!-- Block Content -->
        <div class="row">
            <div class="col-md-12" id="discussion">
                @foreach (var mensaje in Model.Mensajes)
            {
                if (mensaje.Usuario_Id == ViewBag.UserId)
                {
                        <div class="col-md-12">
                            <div class="col-md-6">
                                <div class="row text-left"><strong>@mensaje.Usuario.Nombre</strong></div>
                                <div class="row text-left">@mensaje.Texto</div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="col-md-12">
                            <div class="col-md-offset-6 col-md-6">
                                <div class="row text-left"><strong>@mensaje.Usuario.Nombre</strong></div>
                                <div class="row text-right">@mensaje.Texto</div>
                            </div>
                        </div>
                    }
                }
            </div>
            <div class="col-md-12" style="margin-top:50px;">
                <div class="col-md-10">
                    <textarea class="form-control" id="message"></textarea>
                </div>
                <div class="col-md-2">
                    <input class="btn btn-primary" type="button" id="sendmessage" value="Enviar" />
                </div>
            </div>
        </div>
        <!-- END Block Content -->
    </div>
</div>
<!--Script references. -->
<!--Reference the jQuery library. -->
@*<script src="~/Scripts/jquery-3.2.1.min.js"></script>*@
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<!--Add script to update the page and send messages.-->
<script type="text/javascript">
    $(function () {
        var username = '@ViewBag.Name';
            // Declare a proxy to reference the hub.
            var chat = $.connection.chatHub;
            // Create a function that the hub can call to broadcast messages.
            chat.client.send = function (name, message, userid) {
                // Html encode display name and message.
                var encodedName = $('<div />').text(name).html();
                var encodedMsg = $('<div />').text(message).html();
                // Add the message to the page.
                if (userid == '@ViewBag.UserId') {
                    $('#discussion').append('<div class="col-md-12 text-right"><strong>' + name + '</strong> ' + message + '</div>');
                } else {
                    $('#discussion').append('<div class="col-md-12 text-left"><strong>' + name + '</strong> ' + message + '</div>');
                }
            };
            // Get the user name and store it to prepend to messages.
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                chat.server.joinRoom('@Model.Id');

                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.send(username, $('#message').val(), '@Model.Id', '@ViewBag.UserId');
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });
        });
</script>