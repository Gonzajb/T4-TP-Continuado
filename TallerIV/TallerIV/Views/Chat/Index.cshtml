@model TallerIV.Dominio.Encuentro

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutProui.cshtml";
}

<style>
    .container {
        padding: 5% 5%;
    }

    /* CSS talk bubble */
    .talk-bubble {
        margin: 40px;
        margin-top: 10px;
        margin-bottom: 10px;
        display: inline-block;
        position: relative;
        width: 50%;
        height: auto;
        background-color: lightblue;
    }

    .border {
        border: 8px solid #666;
    }

    .round {
        border-radius: 30px;
        -webkit-border-radius: 30px;
        -moz-border-radius: 30px;
    }

    /* Right triangle placed top left flush. */
    .tri-right.border.left-top:before {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: -40px;
        right: auto;
        top: -8px;
        bottom: auto;
        border: 32px solid;
        border-color: #666 transparent transparent transparent;
    }

    .tri-right.left-top:after {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: -20px;
        right: auto;
        top: 0px;
        bottom: auto;
        border: 22px solid;
        border-color: lightblue transparent transparent transparent;
    }

    /* Right triangle, left side slightly down */
    .tri-right.border.left-in:before {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: -40px;
        right: auto;
        top: 30px;
        bottom: auto;
        border: 20px solid;
        border-color: #666 #666 transparent transparent;
    }

    .tri-right.left-in:after {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: -20px;
        right: auto;
        top: 38px;
        bottom: auto;
        border: 12px solid;
        border-color: lightblue lightblue transparent transparent;
    }

    /*Right triangle, placed bottom left side slightly in*/
    .tri-right.border.btm-left:before {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: -8px;
        right: auto;
        top: auto;
        bottom: -40px;
        border: 32px solid;
        border-color: transparent transparent transparent #666;
    }

    .tri-right.btm-left:after {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: 0px;
        right: auto;
        top: auto;
        bottom: -20px;
        border: 22px solid;
        border-color: transparent transparent transparent lightblue;
    }

    /*Right triangle, placed bottom left side slightly in*/
    .tri-right.border.btm-left-in:before {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: 30px;
        right: auto;
        top: auto;
        bottom: -40px;
        border: 20px solid;
        border-color: #666 transparent transparent #666;
    }

    .tri-right.btm-left-in:after {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: 38px;
        right: auto;
        top: auto;
        bottom: -20px;
        border: 12px solid;
        border-color: lightblue transparent transparent lightblue;
    }

    /*Right triangle, placed bottom right side slightly in*/
    .tri-right.border.btm-right-in:before {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: auto;
        right: 30px;
        bottom: -40px;
        border: 20px solid;
        border-color: #666 #666 transparent transparent;
    }

    .tri-right.btm-right-in:after {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: auto;
        right: 38px;
        bottom: -20px;
        border: 12px solid;
        border-color: lightblue lightblue transparent transparent;
    }
    /*
	left: -8px;
  right: auto;
  top: auto;
	bottom: -40px;
	border: 32px solid;
	border-color: transparent transparent transparent #666;
	left: 0px;
  right: auto;
  top: auto;
	bottom: -20px;
	border: 22px solid;
	border-color: transparent transparent transparent lightblue;

/*Right triangle, placed bottom right side slightly in*/
    .tri-right.border.btm-right:before {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: auto;
        right: -8px;
        bottom: -40px;
        border: 20px solid;
        border-color: #666 #666 transparent transparent;
    }

    .tri-right.btm-right:after {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: auto;
        right: 0px;
        bottom: -20px;
        border: 12px solid;
        border-color: lightblue lightblue transparent transparent;
    }

    /* Right triangle, right side slightly down*/
    .tri-right.border.right-in:before {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: auto;
        right: -40px;
        top: 30px;
        bottom: auto;
        border: 20px solid;
        border-color: #666 transparent transparent #666;
    }

    .tri-right.right-in:after {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: auto;
        right: -20px;
        top: 38px;
        bottom: auto;
        border: 12px solid;
        border-color: lightblue transparent transparent lightblue;
    }

    /* Right triangle placed top right flush. */
    .tri-right.border.right-top:before {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: auto;
        right: -40px;
        top: -8px;
        bottom: auto;
        border: 32px solid;
        border-color: #666 transparent transparent transparent;
    }

    .tri-right.right-top:after {
        content: ' ';
        position: absolute;
        width: 0;
        height: 0;
        left: auto;
        right: -20px;
        top: 0px;
        bottom: auto;
        border: 20px solid;
        border-color: lightblue transparent transparent transparent;
    }

    /* talk bubble contents */
    .talktext {
        padding: 1em;
        text-align: left;
        line-height: 1.5em;
    }

    .talktext p {
        /* remove webkit p margins */
        -webkit-margin-before: 0em;
        -webkit-margin-after: 0em;
    }
</style>

<div class="content-header">
    <div class="header-section">
        <h1>
            <i class="fa fa-chat"></i>Chat
        </h1>
    </div>
</div>
<div class="row">
    <div class="block">
        <!-- Block Title -->
        @*<div class="block-title">
            <h2><strong>Conversación</strong></h2>
        </div>*@
        <!-- END Block Title -->
        <!-- Block Content -->

        <div class="row">
            <div class="col-md-12 pre-scrollable" id="discussion">
                @foreach (var mensaje in Model.Mensajes)
            {
                if (mensaje.Usuario_Id == ViewBag.UserId)
                {
                        <div class="row">
                            <div class="col-md-1">
                                <img src="/Content/themes/proui/img/placeholders/avatars/avatar2.png" alt="avatar" class="img-circle">
                            </div>
                            <div class="col-md-6 talk-bubble tri-right left-top">
                                <div class="row text-left talktext">
                                    <strong>@mensaje.Usuario.Nombre</strong>
                                    <br />
                                    @mensaje.Texto
                                </div>
                            </div>
                            <div class="col-md-5">
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="row">
                            <div class="col-md-4">
                            </div>
                            <div class="col-md-6 talk-bubble tri-right right-top">
                                <div class="row text-left talktext">
                                    <strong>@mensaje.Usuario.Nombre</strong>
                                    <br />
                                    @mensaje.Texto
                                </div>
                            </div>
                            <div class="col-md-1">
                                <img src="/Content/themes/proui/img/placeholders/avatars/avatar2.png" alt="avatar" class="img-circle">
                            </div>
                        </div>
                    }
                }
            </div>
            <div class="col-md-12" style="margin-top:50px;">
                <div class="col-md-10">
                    <input class="form-control" id="message" />
                </div>
                <div class="col-md-2">
                    <input class="btn btn-primary" type="button" id="sendmessage" value="Enviar" />
                </div>
            </div>
        </div>
        <!-- END Block Content -->
    </div>
</div>
<!--Script references. -->
<!--Reference the jQuery library. -->
@*<script src="~/Scripts/jquery-3.2.1.min.js"></script>*@
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<!--Add script to update the page and send messages.-->
<script type="text/javascript">
    $(function () {
        var username = '@ViewBag.Name';
            // Declare a proxy to reference the hub.
            var chat = $.connection.chatHub;
            // Create a function that the hub can call to broadcast messages.
            chat.client.send = function (name, message, userid) {
                // Html encode display name and message.
                var encodedName = $('<div />').text(name).html();
                var encodedMsg = $('<div />').text(message).html();
                // Add the message to the page.
                if (userid == '@ViewBag.UserId') {
                    $('#discussion').append('<div class="row"><div class="col-md-1"><img src="/Content/themes/proui/img/placeholders/avatars/avatar2.png" alt="avatar" class="img-circle"></div><div class="col-md-6 talk-bubble tri-right left-top"><div class="row text-left talktext"><strong>' + name + '</strong><br />' + message + '</div></div><div class="col-md-5"></div></div>');
                } else {
                    $('#discussion').append('<div class="row"><div class="col-md-4"></div><div class="col-md-6 talk-bubble tri-right right-top"><div class="row text-left talktext"><strong>' + name + '</strong><br />' + message + '</div></div><div class="col-md-1"><img src="/Content/themes/proui/img/placeholders/avatars/avatar2.png" alt="avatar" class="img-circle"></div></div>');
                }
            };
            // Get the user name and store it to prepend to messages.
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                chat.server.joinRoom('@Model.Id');

                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.send(username, $('#message').val(), '@Model.Id', '@ViewBag.UserId');
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });
        });
</script>